<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatGo (Bright Career Public School)</title>

<style>
body{margin:0;font-family:Arial;background:#0b141a;color:#e9edef}
header{
  background:#075e54;
  color:#fff;
  padding:10px;
  display:flex;
  align-items:center;
  gap:10px;
}
header img{
  width:42px;
  height:42px;
  border-radius:50%;
  background:#fff;
}
header .title{
  font-size:14px;
  font-weight:bold;
  line-height:1.2;
}
header .school{font-size:12px;opacity:.95}
header .status{font-size:11px;opacity:.85}

#top{padding:10px;background:#111b21}
input{
  width:100%;
  padding:12px;
  margin-bottom:8px;
  border-radius:25px;
  border:1px solid #2a3942;
  background:#0b141a;
  color:#fff;
  font-size:14px;
}
#typing{font-size:12px;opacity:.8;margin:4px 10px}
#chat{height:52vh;overflow:auto;padding:10px}

.row{display:flex;margin:6px 0}
.left{justify-content:flex-start}
.right{justify-content:flex-end}
.bubble{
  max-width:75%;
  padding:10px;
  border-radius:10px;
  background:#202c33;
  font-size:14px;
}
.right .bubble{background:#005c4b}

footer{
  display:flex;
  gap:8px;
  padding:10px;
  background:#111b21;
}
footer input{flex:1}
button{
  border:none;
  border-radius:25px;
  padding:12px 16px;
  background:#25d366;
  font-weight:bold;
  font-size:14px;
}
</style>
</head>

<body>

<header>
  <!-- âœ… LOGO URL -->
  <img src="https://ik.imagekit.io/a2wpi1kd9/imgToUrl/image-to-url_9FkUjGvCmc">
  <div class="title">
    ChatGo
    <div class="school">Bright Career Public School</div>
    <div class="status" id="statusText">offline</div>
  </div>
</header>

<div id="top">
  <input id="name" placeholder="Your name">
  <input id="room" placeholder="Private Room ID">
</div>

<div id="typing"></div>
<div id="chat"></div>

<footer>
  <input id="msg" placeholder="Type message">
  <button id="sendBtn">Send</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, onValue, onDisconnect }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAT0l83gGJipO3aQHpSypkQKeMWy5PwxRU",
  authDomain: "chat-b6a52.firebaseapp.com",
  databaseURL: "https://chat-b6a52-default-rtdb.firebaseio.com",
  projectId: "chat-b6a52",
  messagingSenderId: "108909929088",
  appId: "1:108909929088:web:fd976f913738e8d9a8fc65"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let roomRef=null, statusRef=null, typingRef=null;

const chatBox=document.getElementById("chat");
const nameInput=document.getElementById("name");
const roomInput=document.getElementById("room");
const msgInput=document.getElementById("msg");
const statusText=document.getElementById("statusText");
const typingBox=document.getElementById("typing");

function formatTime(ts){
  return new Date(ts).toLocaleString();
}

roomInput.addEventListener("change",()=>{
  if(!roomInput.value.trim() || !nameInput.value.trim()) return;

  chatBox.innerHTML="";
  const room=roomInput.value.trim();
  const name=nameInput.value.trim();

  roomRef=ref(db,"rooms/"+room+"/messages");
  statusRef=ref(db,"rooms/"+room+"/users/"+name);
  typingRef=ref(db,"rooms/"+room+"/typing/"+name);

  set(statusRef,{state:"online",time:Date.now()});
  onDisconnect(statusRef).set({state:"offline",time:Date.now()});

  onValue(ref(db,"rooms/"+room+"/users"),snap=>{
    let online=false,last="";
    snap.forEach(c=>{
      if(c.key!==name){
        if(c.val().state==="online") online=true;
        else last="last seen "+formatTime(c.val().time);
      }
    });
    statusText.innerText = online ? "online" : last || "offline";
  });

  onValue(ref(db,"rooms/"+room+"/typing"),snap=>{
    let t=[];
    snap.forEach(c=>{
      if(c.key!==name && c.val()==="typing") t.push(c.key);
    });
    typingBox.innerText = t.length ? t.join(", ")+" typing..." : "";
  });

  onChildAdded(roomRef,(snap)=>{
    const d=snap.val();
    const row=document.createElement("div");
    row.className="row "+(d.user===name?"right":"left");
    const bubble=document.createElement("div");
    bubble.className="bubble";
    bubble.innerHTML="<b>"+d.user+"</b><br>"+d.text;
    row.appendChild(bubble);
    chatBox.appendChild(row);
    chatBox.scrollTop=chatBox.scrollHeight;
  });
});

let timer;
msgInput.addEventListener("input",()=>{
  if(!typingRef) return;
  set(typingRef,"typing");
  clearTimeout(timer);
  timer=setTimeout(()=>set(typingRef,""),1200);
});

document.getElementById("sendBtn").onclick=()=>{
  if(!roomRef) return alert("Room ID likho");
  if(!nameInput.value||!msgInput.value) return;
  push(roomRef,{user:nameInput.value,text:msgInput.value,time:Date.now()});
  msgInput.value="";
  set(typingRef,"");
};
</script>

</body>
</html>
